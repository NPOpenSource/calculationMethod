/* Created by user on 17-5-18. */
#include "lwip/lwipopts.h"
#if TEST_TUNNEL
#include <lwip/err.h>
#include <lwip/ip4_addr.h>
#include <lwip/igmp.h>
#include <lwip/inet.h>
#include "../mccp/mccp.h"
#include "tunnel.h"

extern void mptcp_proxy_client_add_netif();
extern err_t
mptcp_proxy_client_netif_output(struct netif *netif, struct pbuf *p, const ip4_addr_t *ipaddr);
extern struct netif mptcp_proxy_client_netif;

//src 192.168.23.04,dst 192.168.23.03  mptcp_cap_syc
u8_t mptcp_syc_pck[] = {
        0x45, 0x00, 0x00, 0x3c, 0x00, 0x01, 0x00, 0x00, 0x40, 0x06,
        0xf5, 0xec, 0xc0, 0xa8, 0x17, 0x04, 0xc1, 0xab, 0x02, 0x65,
        0x13, 0x88, 0xc3, 0x51, 0x66, 0xcf, 0x59, 0x06, 0x00, 0x00,
        0x00, 0x00, 0xa0, 0x02, 0x20, 0x00, 0x66, 0x35, 0x00, 0x00,
        0x02, 0x04, 0x05, 0xb4, 0x01, 0x03, 0x03, 0x07, 0x1e, 0x0c,
        0x00, 0x81, 0x52, 0x30, 0x84, 0xdb, 0x38, 0x77, 0x30, 0x2a
};

u8_t mptcp_cap_ack_pck[] = {
        0x45, 0x00, 0x00, 0x44, 0x00, 0x01, 0x00, 0x00, 0x40, 0x06,
        0xf5, 0xe4, 0xc0, 0xa8, 0x17, 0x04, 0xc0, 0xa8, 0xbf, 0x02,
        0x13, 0x88, 0xc3, 0x51, 0x66, 0xcf, 0x59, 0x07, 0x00, 0x00,
        0x19, 0x8d, 0xc0, 0x10, 0x20, 0x00, 0xac, 0xd2, 0x00, 0x00,
        0x1e, 0x14, 0x00, 0x81, 0x52, 0x30, 0x84, 0xdb, 0x38, 0x77,
        0x30, 0x2a, 0xe5, 0x6d, 0x47, 0xd4, 0x69, 0xc2, 0xd4, 0x34,
        0x1e, 0x08, 0x20, 0x01, 0xbe, 0x8f, 0x23, 0xa6
};

u8_t mptcp_join_syn_pck[] = {
        0x45, 0x00, 0x00, 0x34, 0x00, 0x01, 0x00, 0x00, 0x40, 0x06,
        0xf3, 0xf4, 0xc0, 0xa8, 0x17, 0x04, 0xc0, 0xa8, 0xbf, 0x02,
        0x13, 0x88, 0xc3, 0x51, 0x70, 0x9a, 0xb4, 0xdd, 0x00, 0x00,
        0x00, 0x00, 0x80, 0x02, 0x20, 0x00, 0xd6, 0x61, 0x00, 0x00,
        0x1e, 0x0c, 0x10, 0xef, 0xb3, 0x36, 0x0a, 0x71, 0x77, 0x4c,
        0x4e, 0x46
};

u8_t mptcp_join_ack_pck[] = {
        0x45, 0x00, 0x00, 0x40, 0x00, 0x01, 0x00, 0x00, 0x40, 0x06,
        0xf3, 0xe8, 0xc0, 0xa8, 0x17, 0xb5, 0xc0, 0xa8, 0xbf, 0x02,
        0x13, 0x88, 0xc3, 0x51, 0x70, 0x9a, 0xb4, 0xde, 0x00, 0x00,
        0x19, 0xb6, 0xb0, 0x10, 0x20, 0x00, 0x81, 0x6d, 0x00, 0x00,
        0x1e, 0x18, 0x10, 0x00, 0x20, 0xde, 0xce, 0x4b, 0x46, 0xf4,
        0x0e, 0x53, 0xd4, 0xe3, 0x13, 0x52, 0x71, 0xf0, 0x0e, 0x65,
        0xa1, 0x7c, 0x40, 0xc7
};

void Test_lwip_to_tunnel_init() {
  mptcp_proxy_client_add_netif();
  ppca_s->mccp_mpgw_ip = inet_addr("10.23.41.75");
  ppca_s->mccp_mpgw_port = 50001;
 // create_lte_socket_ext(NULL, ppca_s->mccp_mpgw_ip, ppca_s->mccp_mpgw_port);
}

void t_lwip_ouput_pkt(const u8_t *data, u16_t len) {
  struct pbuf *p, *q;
  err_t err;
  struct netif netif;
  ip4_addr_t ipaddr;

  LWIP_DEBUGF(IP_DEBUG, ("lwip_input_pkt_from_tun enter \n"));
  LWIP_ASSERT("pkt too big", len <= 0xFFFF);
  p = pbuf_alloc(NULL,PBUF_IP, len, PBUF_POOL);
  LWIP_ASSERT("alloc failed", p);
  if (len > p->len) {
    LWIP_DEBUGF(IP_DEBUG,
                ("ip4_nat_input_pkt_from_tun fail. total_len= %d; len = %d \n", len, p->len));
    pbuf_free(p);
    return;
  }

  for (q = p; q != NULL; q = q->next) {
    MEMCPY(q->payload, data, q->len);
    data += q->len;
  }
  err = mptcp_proxy_client_netif_output(&mptcp_proxy_client_netif, p, &ipaddr);
  if (err != ERR_OK) {
    pbuf_free(p);
  }
}

void *test_run(void *data)
{
  isSetLteAddr = 0;
  isSetWifiAddr = 1;
  Test_lwip_to_tunnel_init();
  mutp_start_recv(NULL);
  t_lwip_ouput_pkt(mptcp_syc_pck, sizeof(mptcp_syc_pck));
  return NULL;
}

void Test_lwip_to_tunnel() {
  pthread_t tid;
  /*pthread_create(&tid,NULL,test_run,NULL);*/
  sys_thread_new(NULL,NULL,"Test_lwip_to_tunnel",test_run,NULL,1024,0);
}
#endif